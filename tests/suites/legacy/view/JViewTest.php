<?php
/**
 * @version		$Id: JViewTest.php 20196 2011-01-09 02:40:25Z ian $
 * @copyright	Copyright (C) 2005 - 2012 Open Source Matters. All rights reserved.
 * @license		GNU General Public License version 2 or later; see LICENSE.txt
 */

require_once JPATH_PLATFORM . '/joomla/environment/uri.php';

/**
 * Mockup object to test Model handling in JView
 *
 * @package Joomla.UnitTest
 * @subpackage Application
 * @since 11.3
 */
class ModelMockupJView
{
	public $name = 'model';

	public function getName()
	{
		return $this->name;
	}
}

/**
 * Test class for JView.
 * Generated by PHPUnit on 2009-10-08 at 21:21:58.
 */
class JViewTest extends TestCase
{
	/**
	 * An instance of the test object.
	 *
     * @var    JView
     * @since  12.1
     */
	protected $class;

	/**
	 * @todo Implement test__Construct().
	 */
	public function test__Construct()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement testDisplay().
	 */
	public function testDisplay()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement testAssign().
	 */
	public function testAssign()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement testAssignRef().
	 */
	public function testAssignRef()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement testEscape().
	 */
	public function testEscape()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * Test JView::get()
	 *
	 * @since   11.3
	 * @covers  JView::get
	 */
	public function testGet()
	{
		$this->class->test = 'pass';

		$test2 = new ModelMockupJView;
		$test2->name = 'test2';

		TestReflection::setValue($this->class, '_models', array('test1' => new ModelMockupJView(), 'test2' => $test2));
		TestReflection::setValue($this->class, '_defaultModel', 'test1');

		$this->assertEquals('model', $this->class->get('Name'), 'Checks getName from default model.');
		$this->assertEquals('pass', $this->class->get('test'), 'Checks property from view.');
		$this->assertEquals('test2', $this->class->get('Name', 'test2'), 'Checks getName from model 2.');
	}

	/**
	 * Test JView::getLayout()
	 *
	 * @since   11.3
	 * @covers  JView::getLayout
	 */
	public function testGetLayout()
	{
		$this->assertEquals('default', $this->class->getLayout());

		TestReflection::setValue($this->class, '_layout', 'test1');

		$this->assertEquals('test1', $this->class->getLayout());
	}

	/**
	 * Test JView::getModel()
	 *
	 * @since   11.3
	 * @covers  JView::getModel
	 */
	public function testGetModel()
	{
		//Prepare variable to compare against and a bunch of models
		$models = array();
		$model1 = new ModelMockupJView();
		$models['model'] = $model1;
		$model2 = new ModelMockupJView();
		$model2->name = 'test';
		$models['test'] = $model2;
		$model3 = new ModelMockupJView();
		$model3->name = 'defaulttest';
		$models['defaulttest'] = $model3;

		//Prepare JView object
		TestReflection::setValue($this->class, '_models', $models);
		TestReflection::setValue($this->class, '_defaultModel', 'defaulttest');

		//Assert that the function returns the model with the specific key
		$this->assertThat($this->class->getModel('test'), $this->equalTo($model2));

		//Assert that the function returns the model with an unspecific key
		$this->assertThat($this->class->getModel('Model'), $this->equalTo($model1));

		//Assert that the function returns the default model
		$this->assertThat($this->class->getModel(), $this->equalTo($model3));
	}

	/**
	 * Test JView::getLayoutTemplate()
	 *
	 * @since   11.3
	 * @covers  JView::getLayoutTemplate
	 */
	public function testGetLayoutTemplate()
	{
		$this->assertEquals('_', $this->class->getLayoutTemplate());

		TestReflection::setValue($this->class, '_layoutTemplate', '-');

		$this->assertEquals('-', $this->class->getLayoutTemplate());
	}

	/**
	 * Test JView::getName()
	 *
	 * @since   11.3
	 * @covers  JView::getName
	 */
	public function testGetName()
	{
		$this->assertEquals('', $this->class->getName());

		TestReflection::setValue($this->class, '_name', 'inspector2');

		$this->assertEquals('inspector2', $this->class->getName());
	}

	/**
	 * Test JView::setModel()
	 *
	 * @since   11.3
	 * @covers  JView::setModel
	 */
	public function testSetModel()
	{
		//Prepare variable to compare against and a bunch of models
		$models = array();
		$model1 = new ModelMockupJView;
		$model2 = new ModelMockupJView;
		$model2->name = 'test';
		$model3 = new ModelMockupJView;
		$model3->name = 'defaulttest';

		//Assert that initial state is empty
		$this->assertAttributeEquals($models, '_models', $this->class);

		//Assert that setModel() returns the model handed over
		$this->assertThat($this->class->setModel($model1), $this->equalTo($model1));
		$models['model'] = $model1;

		//Assert that model was correctly added to array
		$this->assertAttributeEquals($models, '_models', $this->class);

		//Assert that having more than one model works
		$this->class->setModel($model2);
		$models['test'] = $model2;

		$this->assertAttributeEquals($models, '_models', $this->class);

		//Assert that default model works correctly
		$this->assertAttributeEquals('', '_defaultModel', $this->class);

		$this->class->setModel($model3, true);
		$models['defaulttest'] = $model3;

		$this->assertAttributeEquals($models, '_models', $this->class);

		$this->assertAttributeEquals('defaulttest', '_defaultModel', $this->class);
	}

	/**
	 * Test JView::setLayout()
	 *
	 * @since   11.3
	 * @covers  JView::setLayout
	 */
	public function testSetLayout()
	{
		$this->assertAttributeEquals('default', '_layout', $this->class);

		$this->class->setLayout('test');

		$this->assertAttributeEquals('test', '_layout', $this->class);
		$this->assertAttributeEquals('_', '_layoutTemplate', $this->class);

		$this->class->setLayout('-:test2');

		$this->assertAttributeEquals('test2', '_layout', $this->class);
		$this->assertAttributeEquals('-', '_layoutTemplate', $this->class);
	}

	/**
	 * Test JView::setLayoutExt()
	 *
	 * @since   11.3
	 * @covers  JView::setLayoutExt
	 */
	public function testSetLayoutExt()
	{
		$this->assertAttributeEquals('php', '_layoutExt', $this->class);

		$this->class->setLayoutExt('tmpl');

		$this->assertAttributeEquals('tmpl', '_layoutExt', $this->class);
	}

	/**
	 * Test JView::setEscape()
	 *
	 * @since   11.3
	 * @covers  JView::setEscape
	 */
	public function testSetEscape()
	{
		$this->assertAttributeEquals('htmlspecialchars', '_escape', $this->class);

		$this->class->setEscape('escapefunc');

		$this->assertAttributeEquals('escapefunc', '_escape', $this->class);

		$this->class->setEscape(array('EscapeClass', 'func'));

		$this->assertAttributeEquals(array('EscapeClass', 'func'), '_escape', $this->class);
	}

	/**
	 * Test JView::addTemplatePath()
	 *
	 * @since   11.3
	 * @covers  JView::addTemplatePath
	 */
	public function testAddTemplatePath()
	{
		$ds = DIRECTORY_SEPARATOR;

		// Reset the internal _path property so we can track it more easily.
		TestReflection::setValue($this->class, '_path', array('helper' => array(), 'template' => array()));

		$this->class->addTemplatePath(JPATH_ROOT . '/libraries');

		$this->assertAttributeEquals(
			array('helper' => array(), 'template' => array(realpath(JPATH_ROOT . '/libraries') . $ds)),
			'_path',
			$this->class
		);

		$this->class->addTemplatePath(JPATH_ROOT . '/cache');

		$this->assertAttributeEquals(
			array('helper' => array(), 'template' => array(realpath(JPATH_ROOT . '/cache') . $ds, realpath(JPATH_ROOT . '/libraries') . $ds)),
			'_path',
			$this->class
		);
	}

	/**
	 * Test JView::addHelperPath()
	 *
	 * @since   11.3
	 * @covers  JView::addHelperPath
	 */
	public function testAddHelperPath()
	{
		$ds = DIRECTORY_SEPARATOR;

		// Reset the internal _path property so we can track it more easily.
		TestReflection::setValue($this->class, '_path', array('helper' => array(), 'template' => array()));

		$this->class->addHelperPath(JPATH_ROOT . '/libraries');

		$this->assertAttributeEquals(
			array('helper' => array(realpath(JPATH_ROOT . '/libraries') . $ds), 'template' => array()),
			'_path',
			$this->class
		);

		$this->class->addHelperPath(JPATH_ROOT . '/cache');

		$this->assertAttributeEquals(
			array('helper' => array(realpath(JPATH_ROOT . '/cache') . $ds, realpath(JPATH_ROOT . '/libraries') . $ds), 'template' => array()),
			'_path',
			$this->class
		);
	}

	/**
	 * @todo Implement testLoadTemplate().
	 */
	public function testLoadTemplate()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement testLoadHelper().
	 */
	public function testLoadHelper()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * @todo Implement test_setPath().
	 */
	public function test_setPath()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
	 * Test JView::_addPath()
	 *
	 * @since   11.3
	 * @covers  JView::_addPath
	 */
	public function test_addPath()
	{
		$ds = DIRECTORY_SEPARATOR;

		// Reset the internal _path property so we can track it more easily.
		TestReflection::setValue($this->class, '_path', array('helper' => array(), 'template' => array()));

		TestReflection::invoke($this->class, '_addPath', 'template', JPATH_ROOT . '/libraries');

		$this->assertAttributeEquals(
			array('helper' => array(), 'template' => array(realpath(JPATH_ROOT . '/libraries') . $ds)),
			'_path',
			$this->class
		);

		TestReflection::invoke($this->class, '_addPath', 'helper', realpath(JPATH_ROOT . '/tests'));

		$this->assertAttributeEquals(
			array('helper' => array(realpath(JPATH_ROOT . '/tests') . $ds), 'template' => array(realpath(JPATH_ROOT . '/libraries') . $ds)),
			'_path',
			$this->class
		);

		TestReflection::invoke($this->class, '_addPath', 'template', realpath(JPATH_ROOT . '/tests'));

		$this->assertAttributeEquals(
			array(
				'helper' => array(realpath(JPATH_ROOT . '/tests') . $ds),
				'template' => array(realpath(JPATH_ROOT . '/tests') . $ds, realpath(JPATH_ROOT . '/libraries') . $ds)
			),
			'_path',
			$this->class
		);

		TestReflection::invoke($this->class, '_addPath', 'helper', realpath(JPATH_ROOT . '/libraries'));

		$this->assertAttributeEquals(
			array(
				'helper' => array(realpath(JPATH_ROOT . '/libraries') . $ds, realpath(JPATH_ROOT . '/tests') . $ds),
				'template' => array(realpath(JPATH_ROOT . '/tests') . $ds, realpath(JPATH_ROOT . '/libraries') . $ds)
			),
			'_path',
			$this->class
		);
	}

	/**
	 * @todo Implement test_createFileName().
	 */
	public function test_createFileName()
	{
		// Remove the following lines when you implement this test.
		$this->markTestIncomplete();
	}

	/**
     * Sets up the fixture.
     *
     * This method is called before a test is executed.
     *
     * @return  void
     *
     * @since   12.1
     */
	protected function setUp()
	{
		parent::setUp();

		$this->saveFactoryState();

		JFactory::$application = TestMockApplication::create($this);

		defined('JPATH_COMPONENT') or define('JPATH_COMPONENT', JPATH_BASE . '/components/com_foobar');
		isset($_SERVER['REQUEST_METHOD']) or ($_SERVER['REQUEST_METHOD'] = 'get');
		isset($_SERVER['HTTP_HOST']) or ($_SERVER['HTTP_HOST'] = 'mydomain.com');

		$this->class = new JView;
	}

	/**
	* Overrides the parent tearDown method.
	*
	* @return  void
	*
	* @since   12.1
	*/
	protected function tearDown()
	{
		parent::tearDown();

		$this->restoreFactoryState();
	}
}
