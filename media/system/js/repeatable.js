(function(e){"use strict";e.JRepeatable=function(t,n){var r=this;if(!r||r===window)return new e.JRepeatable(t,n);r.$container=e(t);if(r.$container.data("JRepeatable"))return r;e("body").append(r.$container),r.$container.data("JRepeatable",r),r.init=function(){r.options=e.extend({},e.JRepeatable.defaults,n),r.$rowsContainer=r.$container.find(r.options.repeatableElement).parent(),r.prepareModal(),r.inputs=[],r.values={},r.prepareTemplate(),r.$input=e(r.options.input);var t=r.$input.val();t&&(r.values=JSON.parse(t));var i=r.inputs[0],s=r.values[i.name].length||1,o=null;for(var u=0;u<s;u++)o=r.addRow(o,u);e(document).on("click",r.options.btModalOpen,function(e){e.preventDefault(),r.modalWindow.modal("show")}),r.modalWindow.on("click",r.options.btModalClose,function(e){e.preventDefault(),r.modalWindow.modal("hide")}),r.$container.on("click",r.options.btAdd,function(t){t.preventDefault();var n=e(this).parents(r.options.repeatableElement);n.length||(n=null),r.addRow(n)}),r.$container.on("click",r.options.btRemove,function(t){t.preventDefault();var n=e(this).parents(r.options.repeatableElement);r.removeRow(n)}),r.$container.trigger("weready")},r.prepareTemplate=function(){var t=r.$container.find(r.options.repeatableElement),n=e(t.get(0));try{r.clearScripts(n)}catch(i){window.console&&console.log(i)}var s=n.find("*[name]");for(var o=0,u=s.length;o<u;o++){var a=e(s[o]).attr("name");if(r.values[a])continue;r.inputs.push({name:a,type:e(s[o]).attr("type")||s[o].tagName.toLowerCase()}),r.values[a]=[]}r.template=n.prop("outerHTML"),r.removeRow(t),r.$container.trigger("prepare-template",r.template)},r.prepareModal=function(){var t=e(r.options.modalElement);t.css({width:"auto","max-height":"80%","max-width":"100%",overflow:"auto"}),t.on("show",function(){r.resizeModal()}),e(window).resize(function(){r.resizeModal()}),t.on("hide",function(){r.refreshValue()}),r.modalWindow=t.modal({show:!1}),r.$container.trigger("prepare-modal",r.modalWindow)},r.resizeModal=function(){var t=e(document).width()/2,n=e(r.modalWindow).width()/2,i=n>t?0:-n,s=i?"50%":0;e(r.modalWindow).css({top:"20%",left:s,"margin-left":i})},r.addRow=function(t,n){var i=r.$container.find(r.options.repeatableElement).length;if(i>=r.options.maximum)return null;var s=e.parseHTML(r.template);t?e(t).after(s):r.$rowsContainer.append(s);var o=e(s);r.fixUniqueAttributes(o,i+1);if(n!==null&&n!==undefined)for(var u=0,a=r.inputs.length;u<a;u++){var f=r.inputs[u].name,l=r.inputs[u].type,c=null;r.values[f]&&(c=r.values[f][n]);if(c===null||c===undefined)continue;if(l==="radio")o.find('*[name*="'+f+'"][value="'+c+'"]').attr("checked","checked");else if(l==="checkbox")if(c.length)for(var h=0,p=c.length;h<p;h++)o.find('*[name*="'+f+'"][value="'+c[h]+'"]').attr("checked","checked");else o.find('*[name*="'+f+'"][value="'+c+'"]').attr("checked","checked");else o.find('*[name*="'+f+'"]').val(c)}try{r.fixScripts(o)}catch(d){window.console&&console.log(d)}return r.$container.trigger("row-add",o),o},r.removeRow=function(t){r.$container.trigger("row-remove",t),e(t).remove()},r.fixUniqueAttributes=function(e,t){var n=e.find("*[id]");r.incresseAttrName(n,"id",t);var i=e.find("label[for]");r.incresseAttrName(i,"for",t);var s=e.find("*[name]");r.incresseAttrName(s,"name",t)},r.incresseAttrName=function(t,n,r){for(var i=0,s=t.length;i<s;i++){var o=e(t[i]),u=o.attr(n);o.attr(n,u+"-"+r)}},r.refreshValue=function(){var t=r.$container.find(r.options.repeatableElement);r.values={};for(var n=0,i=r.inputs.length;n<i;n++){var s=r.inputs[n].name,o=r.inputs[n].type;r.values[s]=[];for(var u=0,a=t.length;u<a;u++){var f=e(t[u]),l=null;if(o==="radio")l=f.find('*[name*="'+s+'"]:checked').val();else if(o==="checkbox"){var c=f.find('*[name*="'+s+'"]:checked');if(c.length>1){l=[];for(var h=0,p=c.length;h<p;h++)l.push(e(c[h]).val())}else l=c.val()}else l=f.find('*[name*="'+s+'"]').val();l=l===null?"":l,r.values[s].push(l)}}r.$input.val(JSON.stringify(r.values)),r.$container.trigger("value-update",r.values)},r.clearScripts=function(t){e.fn.chosen&&t.find("select.chzn-done").chosen("destroy"),e.fn.minicolors&&(t.find(".minicolors input").each(function(){e(this).removeData("minicolors-initialized").removeData("minicolors-settings").removeProp("size").removeProp("maxlength").removeClass("minicolors-input").parents("span.minicolors").parent().append(this)}),t.find("span.minicolors").remove())},r.fixScripts=function(t){e.fn.chosen&&t.find("select").chosen(),t.find(".minicolors").each(function(){var t=e(this);t.minicolors({control:t.attr("data-control")||"hue",position:t.attr("data-position")||"right",theme:"bootstrap"})}),t.find('a[onclick*="jInsertFieldValue"]').each(function(){var t=e(this),n=t.siblings('input[type="text"]').attr("id"),r=t.prev(),i=r.attr("href");t.attr("onclick","jInsertFieldValue('', '"+n+"');return false;"),r.attr("href",i.replace(/&fieldid=(.+)&/,"&fieldid="+n+"&"))}),SqueezeBox.assign(t.find("a.modal").get(),{parse:"rel"})},r.init()},e.JRepeatable.defaults={modalElement:"#modal-container",btModalOpen:"#open-modal",btModalClose:".close-modal",btAdd:"a.add",btRemove:"a.remove",maximum:10,repeatableElement:"table tbody tr",input:"#values-input"},e.fn.JRepeatable=function(t){return this.each(function(){var t=t||{},n=e(this).data();for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r]);new e.JRepeatable(this,t)})},e(window).on("load",function(){e(".form-field-repeatable-container").JRepeatable()})})(jQuery);