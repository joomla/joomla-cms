!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function n(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var o=e.exec(n.string);if(o&&o.index==n.pos)return n.pos+=o[0].length||1,"searching";o?n.pos=o.index:n.skipToEnd()}}}function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new o)}function t(e){return"string"==typeof e&&e==e.toLowerCase()}function i(e,n,o){return e.getSearchCursor(n,o,t(n))}function a(e,n,o,r,t){e.openDialog(n,r,{value:o,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){y(e)},onKeyDown:t})}function s(e,n,o,r,t){e.openDialog?e.openDialog(n,t,{value:r,selectValueOnOpen:!0}):t(prompt(o,r))}function c(e,n,o,r){e.openConfirm?e.openConfirm(n,r):confirm(o)&&r[0]()}function l(e){return e.replace(/\\(.)/g,function(e,n){return"n"==n?"\n":"r"==n?"\r":n})}function u(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=l(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function f(e,o,r){o.queryText=r,o.query=u(r),e.removeOverlay(o.overlay,t(o.query)),o.overlay=n(o.query,t(o.query)),e.addOverlay(o.overlay),e.showMatchesOnScrollbar&&(o.annotate&&(o.annotate.clear(),o.annotate=null),o.annotate=e.showMatchesOnScrollbar(o.query,t(o.query)))}function p(n,o,t,i){var c=r(n);if(c.query)return d(n,o);var l=n.getSelection()||c.lastQuery;if(t&&n.openDialog){var u=null,p=function(o,r){e.e_stop(r),o&&(o!=c.queryText&&(f(n,c,o),c.posFrom=c.posTo=n.getCursor()),u&&(u.style.opacity=1),d(n,r.shiftKey,function(e,o){var r;o.line<3&&document.querySelector&&(r=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>n.cursorCoords(o,"window").top&&((u=r).style.opacity=.4)}))};a(n,h,l,p,function(o,t){var i=e.keyName(o),a=e.keyMap[n.getOption("keyMap")][i];a||(a=n.getOption("extraKeys")[i]),"findNext"==a||"findPrev"==a||"findPersistentNext"==a||"findPersistentPrev"==a?(e.e_stop(o),f(n,r(n),t),n.execCommand(a)):"find"!=a&&"findPersistent"!=a||(e.e_stop(o),p(t,o))}),i&&l&&(f(n,c,l),d(n,o))}else s(n,h,"Search for:",l,function(e){e&&!c.query&&n.operation(function(){f(n,c,e),c.posFrom=c.posTo=n.getCursor(),d(n,o)})})}function d(n,o,t){n.operation(function(){var a=r(n),s=i(n,a.query,o?a.posFrom:a.posTo);(s.find(o)||(s=i(n,a.query,o?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(o))&&(n.setSelection(s.from(),s.to()),n.scrollIntoView({from:s.from(),to:s.to()},20),a.posFrom=s.from(),a.posTo=s.to(),t&&t(s.from(),s.to()))})}function y(e){e.operation(function(){var n=r(e);n.lastQuery=n.query,n.query&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))})}function m(e,n,o){e.operation(function(){for(var r=i(e,n);r.findNext();)if("string"!=typeof n){var t=e.getRange(r.from(),r.to()).match(n);r.replace(o.replace(/\$(\d)/g,function(e,n){return t[n]}))}else r.replace(o)})}function g(e,n){if(!e.getOption("readOnly")){var o=e.getSelection()||r(e).lastQuery,t='<span class="CodeMirror-search-label">'+(n?"Replace all:":"Replace:")+"</span>";s(e,t+v,t,o,function(o){o&&(o=u(o),s(e,x,"Replace with:","",function(r){if(r=l(r),n)m(e,o,r);else{y(e);var t=i(e,o,e.getCursor("from")),a=function(){var n,l=t.from();!(n=t.findNext())&&(t=i(e,o),!(n=t.findNext())||l&&t.from().line==l.line&&t.from().ch==l.ch)||(e.setSelection(t.from(),t.to()),e.scrollIntoView({from:t.from(),to:t.to()}),c(e,C,"Replace?",[function(){s(n)},a,function(){m(e,o,r)}]))},s=function(e){t.replace("string"==typeof o?r:r.replace(/\$(\d)/g,function(n,o){return e[o]})),a()};a()}}))})}}var h='<span class="CodeMirror-search-label">Search:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',v=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',x='<span class="CodeMirror-search-label">With:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',C='<span class="CodeMirror-search-label">Replace?</span> <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>';e.commands.find=function(e){y(e),p(e)},e.commands.findPersistent=function(e){y(e),p(e,!1,!0)},e.commands.findPersistentNext=function(e){p(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){p(e,!0,!0,!0)},e.commands.findNext=p,e.commands.findPrev=function(e){p(e,!0)},e.commands.clearSearch=y,e.commands.replace=g,e.commands.replaceAll=function(e){g(e,!0)}}),function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function n(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var o=e.exec(n.string);if(o&&o.index==n.pos)return n.pos+=o[0].length||1,"searching";o?n.pos=o.index:n.skipToEnd()}}}function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new o)}function t(e){return"string"==typeof e&&e==e.toLowerCase()}function i(e,n,o){return e.getSearchCursor(n,o,t(n))}function a(e,n,o,r,t){e.openDialog(n,r,{value:o,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){y(e)},onKeyDown:t})}function s(e,n,o,r,t){e.openDialog?e.openDialog(n,t,{value:r,selectValueOnOpen:!0}):t(prompt(o,r))}function c(e,n,o,r){e.openConfirm?e.openConfirm(n,r):confirm(o)&&r[0]()}function l(e){return e.replace(/\\(.)/g,function(e,n){return"n"==n?"\n":"r"==n?"\r":n})}function u(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=l(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function f(e,o,r){o.queryText=r,o.query=u(r),e.removeOverlay(o.overlay,t(o.query)),o.overlay=n(o.query,t(o.query)),e.addOverlay(o.overlay),e.showMatchesOnScrollbar&&(o.annotate&&(o.annotate.clear(),o.annotate=null),o.annotate=e.showMatchesOnScrollbar(o.query,t(o.query)))}function p(n,o,t,i){var c=r(n);if(c.query)return d(n,o);var l=n.getSelection()||c.lastQuery;if(t&&n.openDialog){var u=null,p=function(o,r){e.e_stop(r),o&&(o!=c.queryText&&(f(n,c,o),c.posFrom=c.posTo=n.getCursor()),u&&(u.style.opacity=1),d(n,r.shiftKey,function(e,o){var r;o.line<3&&document.querySelector&&(r=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>n.cursorCoords(o,"window").top&&((u=r).style.opacity=.4)}))};a(n,h,l,p,function(o,t){var i=e.keyName(o),a=e.keyMap[n.getOption("keyMap")][i];a||(a=n.getOption("extraKeys")[i]),"findNext"==a||"findPrev"==a||"findPersistentNext"==a||"findPersistentPrev"==a?(e.e_stop(o),f(n,r(n),t),n.execCommand(a)):"find"!=a&&"findPersistent"!=a||(e.e_stop(o),p(t,o))}),i&&l&&(f(n,c,l),d(n,o))}else s(n,h,"Search for:",l,function(e){e&&!c.query&&n.operation(function(){f(n,c,e),c.posFrom=c.posTo=n.getCursor(),d(n,o)})})}function d(n,o,t){n.operation(function(){var a=r(n),s=i(n,a.query,o?a.posFrom:a.posTo);(s.find(o)||(s=i(n,a.query,o?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(o))&&(n.setSelection(s.from(),s.to()),n.scrollIntoView({from:s.from(),to:s.to()},20),a.posFrom=s.from(),a.posTo=s.to(),t&&t(s.from(),s.to()))})}function y(e){e.operation(function(){var n=r(e);n.lastQuery=n.query,n.query&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))})}function m(e,n,o){e.operation(function(){for(var r=i(e,n);r.findNext();)if("string"!=typeof n){var t=e.getRange(r.from(),r.to()).match(n);r.replace(o.replace(/\$(\d)/g,function(e,n){return t[n]}))}else r.replace(o)})}function g(e,n){if(!e.getOption("readOnly")){var o=e.getSelection()||r(e).lastQuery,t='<span class="CodeMirror-search-label">'+(n?"Replace all:":"Replace:")+"</span>";s(e,t+v,t,o,function(o){o&&(o=u(o),s(e,x,"Replace with:","",function(r){if(r=l(r),n)m(e,o,r);else{y(e);var t=i(e,o,e.getCursor("from")),a=function(){var n,l=t.from();!(n=t.findNext())&&(t=i(e,o),!(n=t.findNext())||l&&t.from().line==l.line&&t.from().ch==l.ch)||(e.setSelection(t.from(),t.to()),e.scrollIntoView({from:t.from(),to:t.to()}),c(e,C,"Replace?",[function(){s(n)},a,function(){m(e,o,r)}]))},s=function(e){t.replace("string"==typeof o?r:r.replace(/\$(\d)/g,function(n,o){return e[o]})),a()};a()}}))})}}var h='<span class="CodeMirror-search-label">Search:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',v=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',x='<span class="CodeMirror-search-label">With:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',C='<span class="CodeMirror-search-label">Replace?</span> <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>';e.commands.find=function(e){y(e),p(e)},e.commands.findPersistent=function(e){y(e),p(e,!1,!0)},e.commands.findPersistentNext=function(e){p(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){p(e,!0,!0,!0)},e.commands.findNext=p,e.commands.findPrev=function(e){p(e,!0)},e.commands.clearSearch=y,e.commands.replace=g,e.commands.replaceAll=function(e){g(e,!0)}});