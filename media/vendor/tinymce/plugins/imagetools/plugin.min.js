!function(){"use strict";var t=function(e){var n=e,r=function(){return n};return{get:r,set:function(t){n=t},clone:function(){return t(r())}}},e=tinymce.util.Tools.resolve("tinymce.PluginManager"),n=tinymce.util.Tools.resolve("tinymce.util.Tools");function r(t,e){return i(document.createElement("canvas"),t,e)}function o(t){return t.getContext("2d")}function i(t,e,n){return t.width=e,t.height=n,t}var a={create:r,clone:function(t){var e;return o(e=r(t.width,t.height)).drawImage(t,0,0),e},resize:i,get2dContext:o,get3dContext:function(t){var e=null;try{e=t.getContext("webgl")||t.getContext("experimental-webgl")}catch(t){}return e||(e=null),e}},u={getWidth:function(t){return t.naturalWidth||t.width},getHeight:function(t){return t.naturalHeight||t.height}},c=window.Promise?window.Promise:function(){var t=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],c(t,n(i,this),n(a,this))},e=t.immediateFn||"function"==typeof setImmediate&&setImmediate||function(t){setTimeout(t,1)};function n(t,e){return function(){t.apply(e,arguments)}}var r=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function o(t){var n=this;null!==this._state?e(function(){var e=n._state?t.onFulfilled:t.onRejected;if(null!==e){var r;try{r=e(n._value)}catch(e){return void t.reject(e)}t.resolve(r)}else(n._state?t.resolve:t.reject)(n._value)}):this._deferreds.push(t)}function i(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void c(n(e,t),n(i,this),n(a,this))}this._state=!0,this._value=t,u.call(this)}catch(t){a.call(this,t)}}function a(t){this._state=!1,this._value=t,u.call(this)}function u(){for(var t=0,e=this._deferreds.length;t<e;t++)o.call(this,this._deferreds[t]);this._deferreds=null}function c(t,e,n){var r=!1;try{t(function(t){r||(r=!0,e(t))},function(t){r||(r=!0,n(t))})}catch(t){if(r)return;r=!0,n(t)}}return t.prototype.catch=function(t){return this.then(null,t)},t.prototype.then=function(e,n){var r=this;return new t(function(t,i){o.call(r,new function(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}(e,n,t,i))})},t.all=function(){var e=Array.prototype.slice.call(1===arguments.length&&r(arguments[0])?arguments[0]:arguments);return new t(function(t,n){if(0===e.length)return t([]);var r=e.length;function o(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var u=a.then;if("function"==typeof u)return void u.call(a,function(t){o(i,t)},n)}e[i]=a,0==--r&&t(e)}catch(t){n(t)}}for(var i=0;i<e.length;i++)o(i,e[i])})},t.resolve=function(e){return e&&"object"==typeof e&&e.constructor===t?e:new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.race=function(e){return new t(function(t,n){for(var r=0,o=e.length;r<o;r++)e[r].then(t,n)})},t}(),l=function(t){return function(){return t}},s={noop:function(){},noarg:function(t){return function(){return t()}},compose:function(t,e){return function(){return t(e.apply(null,arguments))}},constant:l,identity:function(t){return t},tripleEquals:function(t,e){return t===e},curry:function(t){for(var e=new Array(arguments.length-1),n=1;n<arguments.length;n++)e[n-1]=arguments[n];return function(){for(var n=new Array(arguments.length),r=0;r<n.length;r++)n[r]=arguments[r];var o=e.concat(n);return t.apply(null,o)}},not:function(t){return function(){return!t.apply(null,arguments)}},die:function(t){return function(){throw new Error(t)}},apply:function(t){return t()},call:function(t){t()},never:l(!1),always:l(!0)},f=s.never,d=s.always,h=function(){return p},p=function(){var t=function(t){return t.isNone()},e=function(t){return t()},n=function(t){return t},r={fold:function(t,e){return t()},is:f,isSome:f,isNone:d,getOr:n,getOrThunk:e,getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},or:n,orThunk:e,map:h,ap:h,each:function(){},bind:h,flatten:h,exists:f,forall:d,filter:h,equals:t,equals_:t,toArray:function(){return[]},toString:s.constant("none()")};return Object.freeze&&Object.freeze(r),r}(),m=function(t){var e=function(){return t},n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:d,isNone:f,getOr:e,getOrThunk:e,getOrDie:e,or:n,orThunk:n,map:function(e){return m(e(t))},ap:function(e){return e.fold(h,function(e){return m(e(t))})},each:function(e){e(t)},bind:r,flatten:e,exists:r,forall:r,filter:function(e){return e(t)?o:p},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(f,function(e){return n(t,e)})},toArray:function(){return[t]},toString:function(){return"some("+t+")"}};return o},g={some:m,none:h,from:function(t){return null===t||void 0===t?p:m(t)}},v="undefined"!=typeof window?window:Function("return this;")(),y=function(t,e){for(var n=void 0!==e&&null!==e?e:v,r=0;r<t.length&&void 0!==n&&null!==n;++r)n=n[t[r]];return n},b=function(t,e){var n=t.split(".");return y(n,e)},w={getOrDie:function(t,e){var n=function(t,e){return b(t,e)}(t,e);if(void 0===n||null===n)throw t+" not available on this browser";return n}};function x(){return new(w.getOrDie("FileReader"))}var R={atob:function(t){return w.getOrDie("atob")(t)},requestAnimationFrame:function(t){w.getOrDie("requestAnimationFrame")(t)}};function I(t){return new c(function(e,n){var r=URL.createObjectURL(t),o=new Image,i=function(){o.removeEventListener("load",a),o.removeEventListener("error",u)};function a(){i(),e(o)}function u(){i(),n("Unable to load data of type "+t.type+": "+r)}o.addEventListener("load",a),o.addEventListener("error",u),o.src=r,o.complete&&a()})}function T(t){return new c(function(e,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.onload=function(){200==this.status&&e(this.response)},r.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},r.send()})}function k(t){var e=t.split(","),n=/data:([^;]+)/.exec(e[0]);if(!n)return g.none();for(var r,o,i,a=n[1],u=e[1],c=R.atob(u),l=c.length,s=Math.ceil(l/1024),f=new Array(s),d=0;d<s;++d){for(var h=1024*d,p=Math.min(h+1024,l),m=new Array(p-h),v=h,y=0;v<p;++y,++v)m[y]=c[v].charCodeAt(0);f[d]=(r=m,new(w.getOrDie("Uint8Array"))(r))}return g.some((o=f,i={type:a},new(w.getOrDie("Blob"))(o,i)))}function C(t){return new c(function(e,n){k(t).fold(function(){n("uri is not base64: "+t)},e)})}function B(t){return new c(function(e){var n=new x;n.onloadend=function(){e(n.result)},n.readAsDataURL(t)})}var U={blobToImage:I,imageToBlob:function(t){return function(t){return new c(function(e){t.complete?e(t):t.addEventListener("load",function n(){t.removeEventListener("load",n),e(t)})})}(t).then(function(t){var e=t.src;return 0===e.indexOf("blob:")?T(e):0===e.indexOf("data:")?C(e):T(e)})},blobToDataUri:B,blobToBase64:function(t){return B(t).then(function(t){return t.split(",")[1]})},dataUriToBlobSync:k,canvasToBlob:function(t,e,n){return e=e||"image/png",HTMLCanvasElement.prototype.toBlob?new c(function(r){t.toBlob(function(t){r(t)},e,n)}):C(t.toDataURL(e,n))},canvasToDataURL:function(t,e,n){return e=e||"image/png",t.then(function(t){return t.toDataURL(e,n)})},blobToCanvas:function(t){return I(t).then(function(t){var e;return function(t){URL.revokeObjectURL(t.src)}(t),e=a.create(u.getWidth(t),u.getHeight(t)),a.get2dContext(e).drawImage(t,0,0),e})},uriToBlob:function(t){return 0===t.indexOf("blob:")?T(t):0===t.indexOf("data:")?C(t):null}},M=function(t){return U.blobToImage(t)},j=function(t){return U.imageToBlob(t)};function E(t,e,n){var r=e.type;function o(e,n){return t.then(function(t){return U.canvasToDataURL(t,e,n)})}return{getType:s.constant(r),toBlob:function(){return c.resolve(e)},toDataURL:function(){return n},toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return U.canvasToBlob(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(a.clone)}}}function A(t){return U.blobToDataUri(t).then(function(e){return E(U.blobToCanvas(t),t,e)})}var z={fromBlob:A,fromCanvas:function(t,e){return U.canvasToBlob(t,e).then(function(e){return E(c.resolve(t),e,t.toDataURL())})},fromImage:function(t){return U.imageToBlob(t).then(function(t){return A(t)})},fromBlobAndUrlSync:function(t,e){return E(U.blobToCanvas(t),t,e)}};function O(t,e,n){return(t=parseFloat(t))>n?t=n:t<e&&(t=e),t}var D=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10];function S(t,e){var n,r,o,i,a=[],u=new Array(10);for(n=0;n<5;n++){for(r=0;r<5;r++)a[r]=e[r+5*n];for(r=0;r<5;r++){for(i=0,o=0;o<5;o++)i+=t[r+5*o]*a[o];u[r+5*n]=i}}return u}function L(t,e){return e=O(e,0,1),t.map(function(t,n){return n%6==0?t=1-(1-t)*e:t*=e,O(t,0,1)})}var H={identity:function(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]},adjust:L,multiply:S,adjustContrast:function(t,e){var n;return e=O(e,-1,1),S(t,[(n=(e*=100)<0?127+e/100*127:127*(n=0==(n=e%1)?D[e]:D[Math.floor(e)]*(1-n)+D[Math.floor(e)+1]*n)+127)/127,0,0,0,.5*(127-n),0,n/127,0,0,.5*(127-n),0,0,n/127,0,.5*(127-n),0,0,0,1,0,0,0,0,0,1])},adjustBrightness:function(t,e){return S(t,[1,0,0,0,e=O(255*e,-255,255),0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])},adjustSaturation:function(t,e){var n;return S(t,[.3086*(1-(n=1+((e=O(e,-1,1))>0?3*e:e)))+n,.6094*(1-n),.082*(1-n),0,0,.3086*(1-n),.6094*(1-n)+n,.082*(1-n),0,0,.3086*(1-n),.6094*(1-n),.082*(1-n)+n,0,0,0,0,0,1,0,0,0,0,0,1])},adjustHue:function(t,e){var n,r;return e=O(e,-180,180)/180*Math.PI,S(t,[.213+.787*(n=Math.cos(e))+-.213*(r=Math.sin(e)),.715+-.715*n+-.715*r,.072+-.072*n+.928*r,0,0,.213+-.213*n+.143*r,.715+n*(1-.715)+.14*r,.072+-.072*n+-.283*r,0,0,.213+-.213*n+-.787*r,.715+-.715*n+.715*r,.072+.928*n+.072*r,0,0,0,0,0,1,0,0,0,0,0,1])},adjustColors:function(t,e,n,r){return S(t,[e=O(e,0,2),0,0,0,0,0,n=O(n,0,2),0,0,0,0,0,r=O(r,0,2),0,0,0,0,0,1,0,0,0,0,0,1])},adjustSepia:function(t,e){return S(t,L([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],e=O(e,0,1)))},adjustGrayscale:function(t,e){return S(t,L([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],e=O(e,0,1)))}};function _(t,e){return t.toCanvas().then(function(n){return function(t,e,n){var r,o=a.get2dContext(t);return r=function(t,e){var n,r,o,i,a,u=t.data,c=e[0],l=e[1],s=e[2],f=e[3],d=e[4],h=e[5],p=e[6],m=e[7],g=e[8],v=e[9],y=e[10],b=e[11],w=e[12],x=e[13],R=e[14],I=e[15],T=e[16],k=e[17],C=e[18],B=e[19];for(a=0;a<u.length;a+=4)n=u[a],r=u[a+1],o=u[a+2],i=u[a+3],u[a]=n*c+r*l+o*s+i*f+d,u[a+1]=n*h+r*p+o*m+i*g+v,u[a+2]=n*y+r*b+o*w+i*x+R,u[a+3]=n*I+r*T+o*k+i*C+B;return t}(o.getImageData(0,0,t.width,t.height),n),o.putImageData(r,0,0),z.fromCanvas(t,e)}(n,t.getType(),e)})}function F(t,e){return t.toCanvas().then(function(n){return function(t,e,n){var r,o,i=a.get2dContext(t);return r=i.getImageData(0,0,t.width,t.height),o=i.getImageData(0,0,t.width,t.height),o=function(t,e,n){var r,o,i,a,u,c,l,s,f,d,h,p,m,g,v,y,b;function w(t,e,n){return t>n?t=n:t<e&&(t=e),t}for(i=Math.round(Math.sqrt(n.length)),a=Math.floor(i/2),r=t.data,o=e.data,y=t.width,b=t.height,c=0;c<b;c++)for(u=0;u<y;u++){for(l=s=f=0,h=0;h<i;h++)for(d=0;d<i;d++)p=w(u+d-a,0,y-1),m=w(c+h-a,0,b-1),g=4*(m*y+p),v=n[h*i+d],l+=r[g]*v,s+=r[g+1]*v,f+=r[g+2]*v;o[g=4*(c*y+u)]=w(l,0,255),o[g+1]=w(s,0,255),o[g+2]=w(f,0,255)}return e}(r,o,n),i.putImageData(o,0,0),z.fromCanvas(t,e)}(n,t.getType(),e)})}function P(t){return function(e,n){return e.toCanvas().then(function(r){return function(e,n,r){var o,i,u=a.get2dContext(e),c=new Array(256);for(i=0;i<c.length;i++)c[i]=t(i,r);return o=function(t,e){var n,r=t.data;for(n=0;n<r.length;n+=4)r[n]=e[r[n]],r[n+1]=e[r[n+1]],r[n+2]=e[r[n+2]];return t}(u.getImageData(0,0,e.width,e.height),c),u.putImageData(o,0,0),z.fromCanvas(e,n)}(r,e.getType(),n)})}}function W(t){return function(e,n){return _(e,t(H.identity(),n))}}function q(t){return function(e){return F(e,t)}}var V,N={invert:(V=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0],function(t){return _(t,V)}),brightness:W(H.adjustBrightness),hue:W(H.adjustHue),saturate:W(H.adjustSaturation),contrast:W(H.adjustContrast),grayscale:W(H.adjustGrayscale),sepia:W(H.adjustSepia),colorize:function(t,e,n,r){return _(t,H.adjustColors(H.identity(),e,n,r))},sharpen:q([0,-1,0,-1,5,-1,0,-1,0]),emboss:q([-2,-1,0,-1,1,1,0,1,2]),gamma:P(function(t,e){return 255*Math.pow(t/255,1-e)}),exposure:P(function(t,e){return 255*(1-Math.exp(-t/255*e))}),colorFilter:_,convoluteFilter:F},$={scale:function t(e,n,r){var o=u.getWidth(e),i=u.getHeight(e),l=n/o,s=r/i,f=!1;(l<.5||l>2)&&(l=l<.5?.5:2,f=!0),(s<.5||s>2)&&(s=s<.5?.5:2,f=!0);var d=function(t,e,n){return new c(function(r){var o=u.getWidth(t),i=u.getHeight(t),c=Math.floor(o*e),l=Math.floor(i*n),s=a.create(c,l),f=a.get2dContext(s);f.drawImage(t,0,0,o,i,0,0,c,l),r(s)})}(e,l,s);return f?d.then(function(e){return t(e,n,r)}):d}},X={rotate:function(t,e){return t.toCanvas().then(function(n){return function(t,e,n){var r=a.create(t.width,t.height),o=a.get2dContext(r),i=0,u=0;return 90!=(n=n<0?360+n:n)&&270!=n||a.resize(r,r.height,r.width),90!=n&&180!=n||(i=r.width),270!=n&&180!=n||(u=r.height),o.translate(i,u),o.rotate(n*Math.PI/180),o.drawImage(t,0,0),z.fromCanvas(r,e)}(n,t.getType(),e)})},flip:function(t,e){return t.toCanvas().then(function(n){return function(t,e,n){var r=a.create(t.width,t.height),o=a.get2dContext(r);return"v"==n?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0)),z.fromCanvas(r,e)}(n,t.getType(),e)})},crop:function(t,e,n,r,o){return t.toCanvas().then(function(i){return function(t,e,n,r,o,i){var u=a.create(o,i);return a.get2dContext(u).drawImage(t,-n,-r),z.fromCanvas(u,e)}(i,t.getType(),e,n,r,o)})},resize:function(t,e,n){return t.toCanvas().then(function(r){return $.scale(r,e,n).then(function(e){return z.fromCanvas(e,t.getType())})})}},G={invert:function(t){return N.invert(t)},sharpen:function(t){return N.sharpen(t)},emboss:function(t){return N.emboss(t)},brightness:function(t,e){return N.brightness(t,e)},hue:function(t,e){return N.hue(t,e)},saturate:function(t,e){return N.saturate(t,e)},contrast:function(t,e){return N.contrast(t,e)},grayscale:function(t,e){return N.grayscale(t,e)},sepia:function(t,e){return N.sepia(t,e)},colorize:function(t,e,n,r){return N.colorize(t,e,n,r)},gamma:function(t,e){return N.gamma(t,e)},exposure:function(t,e){return N.exposure(t,e)},flip:function(t,e){return X.flip(t,e)},crop:function(t,e,n,r,o){return X.crop(t,e,n,r,o)},resize:function(t,e,n){return X.resize(t,e,n)},rotate:function(t,e){return X.rotate(t,e)}},Y=function(t){return t.toBlob()},J={blobToImageResult:function(t){return z.fromBlob(t)},fromBlobAndUrlSync:function(t,e){return z.fromBlobAndUrlSync(t,e)},imageToImageResult:function(t){return z.fromImage(t)},imageResultToBlob:function(t,e,n){return void 0===e&&void 0===n?Y(t):t.toAdjustedBlob(e,n)},imageResultToOriginalBlob:Y,imageResultToDataURL:function(t){return t.toDataURL()}},K=function(){return w.getOrDie("URL")},Z={createObjectURL:function(t){return K().createObjectURL(t)},revokeObjectURL:function(t){K().revokeObjectURL(t)}},Q=tinymce.util.Tools.resolve("tinymce.util.Delay"),tt=tinymce.util.Tools.resolve("tinymce.util.Promise"),et=tinymce.util.Tools.resolve("tinymce.util.URI"),nt=function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions")},rt=function(t){return t.getParam("imagetools_proxy")},ot=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),it=tinymce.util.Tools.resolve("tinymce.ui.Factory"),at=tinymce.util.Tools.resolve("tinymce.geom.Rect"),ut=function(t){return new tt(function(e){var n=function(){t.removeEventListener("load",n),e(t)};t.complete?e(t):t.addEventListener("load",n)})},ct=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),lt=tinymce.util.Tools.resolve("tinymce.util.Observable"),st=tinymce.util.Tools.resolve("tinymce.util.VK"),ft=0,dt={create:function(t){return new(it.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(t){var e=this,n=new Image;n.src=t,ut(n).then(function(){var t,r,o=e.state.get("viewRect");if((r=e.$el.find("img"))[0])r.replaceWith(n);else{var i=document.createElement("div");i.className="mce-imagepanel-bg",e.getEl().appendChild(i),e.getEl().appendChild(n)}t={x:0,y:0,w:n.naturalWidth,h:n.naturalHeight},e.state.set("viewRect",t),e.state.set("rect",at.inflate(t,-20,-20)),o&&o.w===t.w&&o.h===t.h||e.zoomFit(),e.repaintImage(),e.fire("load")})},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t,e,n,r,o,i;t=this.$el.find("img"),e=this.getEl().clientWidth,n=this.getEl().clientHeight,r=t[0].naturalWidth,o=t[0].naturalHeight,(i=Math.min((e-10)/r,(n-10)/o))>=1&&(i=1),this.zoom(i)},repaintImage:function(){var t,e,n,r,o,i,a,u,c,l,s;s=this.getEl(),c=this.zoom(),l=this.state.get("rect"),a=this.$el.find("img"),u=this.$el.find(".mce-imagepanel-bg"),o=s.offsetWidth,i=s.offsetHeight,n=a[0].naturalWidth*c,r=a[0].naturalHeight*c,t=Math.max(0,o/2-n/2),e=Math.max(0,i/2-r/2),a.css({left:t,top:e,width:n,height:r}),u.css({left:t,top:e,width:n,height:r}),this.cropRect&&(this.cropRect.setRect({x:l.x*c+t,y:l.y*c+e,w:l.w*c,h:l.h*c}),this.cropRect.setClampRect({x:t,y:e,w:n,h:r}),this.cropRect.setViewPortRect({x:0,y:0,w:o,h:i}))},bindStates:function(){var t=this;function e(e){t.cropRect=function(t,e,r,o,i){var a,u,c,l,s="mce-",f=s+"crid-"+ft++;function d(t,e){return{x:e.x-t.x,y:e.y-t.y,w:e.w,h:e.h}}function h(e,n,o,i){var u,c,l,s,f;u=n.x,c=n.y,l=n.w,s=n.h,u+=o*e.deltaX,c+=i*e.deltaY,l+=o*e.deltaW,s+=i*e.deltaH,l<20&&(l=20),s<20&&(s=20),f=t=at.clamp({x:u,y:c,w:l,h:s},r,"move"===e.name),f=d(r,f),a.fire("updateRect",{rect:f}),g(f)}function p(t){function r(t,e){e.h<0&&(e.h=0),e.w<0&&(e.w=0),ct("#"+f+"-"+t,o).css({left:e.x,top:e.y,width:e.w,height:e.h})}n.each(u,function(e){ct("#"+f+"-"+e.name,o).css({left:t.w*e.xMul+t.x,top:t.h*e.yMul+t.y})}),r("top",{x:e.x,y:e.y,w:e.w,h:t.y-e.y}),r("right",{x:t.x+t.w,y:t.y,w:e.w-t.x-t.w+e.x,h:t.h}),r("bottom",{x:e.x,y:t.y+t.h,w:e.w,h:e.h-t.y-t.h+e.y}),r("left",{x:e.x,y:t.y,w:t.x-e.x,h:t.h}),r("move",t)}function m(e){p(t=e)}function g(t){var e,n;m((e=r,{x:(n=t).x+e.x,y:n.y+e.y,w:n.w,h:n.h}))}return u=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],l=["top","right","bottom","left"],ct('<div id="'+f+'" class="'+s+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(o),n.each(l,function(t){ct("#"+f,o).append('<div id="'+f+"-"+t+'"class="'+s+'croprect-block" style="display: none" data-mce-bogus="all">')}),n.each(u,function(t){ct("#"+f,o).append('<div id="'+f+"-"+t.name+'" class="'+s+"croprect-handle "+s+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),c=n.map(u,function(e){var n;return new(it.get("DragHelper"))(f,{document:o.ownerDocument,handle:f+"-"+e.name,start:function(){n=t},drag:function(t){h(e,n,t.deltaX,t.deltaY)}})}),p(t),ct(o).on("focusin focusout",function(t){ct(t.target).attr("aria-grabbed","focus"===t.type)}),ct(o).on("keydown",function(e){var r;function o(t,e,n,o,i){t.stopPropagation(),t.preventDefault(),h(r,n,o,i)}switch(n.each(u,function(t){if(e.target.id===f+"-"+t.name)return r=t,!1}),e.keyCode){case st.LEFT:o(e,0,t,-10,0);break;case st.RIGHT:o(e,0,t,10,0);break;case st.UP:o(e,0,t,0,-10);break;case st.DOWN:o(e,0,t,0,10);break;case st.ENTER:case st.SPACEBAR:e.preventDefault(),i()}}),a=n.extend({toggleVisibility:function(t){var e;e=n.map(u,function(t){return"#"+f+"-"+t.name}).concat(n.map(l,function(t){return"#"+f+"-"+t})).join(","),t?ct(e,o).show():ct(e,o).hide()},setClampRect:function(e){r=e,p(t)},setRect:m,getInnerRect:function(){return d(r,t)},setInnerRect:g,setViewPortRect:function(n){e=n,p(t)},destroy:function(){n.each(c,function(t){t.destroy()}),c=[]}},lt)}(e,t.state.get("viewRect"),t.state.get("viewRect"),t.getEl(),function(){t.fire("crop")}),t.cropRect.on("updateRect",function(e){var n=e.rect,r=t.zoom();n={x:Math.round(n.x/r),y:Math.round(n.y/r),w:Math.round(n.w/r),h:Math.round(n.h/r)},t.state.set("rect",n)}),t.on("remove",t.cropRect.destroy)}t.state.on("change:cropEnabled",function(e){t.cropRect.toggleVisibility(e.value),t.repaintImage()}),t.state.on("change:zoom",function(){t.repaintImage()}),t.state.on("change:rect",function(n){var r=n.value;t.cropRect||e(r),t.cropRect.setRect(r)})}}))(t)}};function ht(t){return{blob:t,url:Z.createObjectURL(t)}}function pt(t){t&&Z.revokeObjectURL(t.url)}function mt(t){n.each(t,pt)}function gt(t,e,r,o){var i,a,u,c,l,s,f,d,h,p,m,g,v,y,b,w,x,R,I,T,k,C,B,U,M,j,E,A=function(){var t=[],e=-1;function n(){return e>0}function r(){return-1!==e&&e<t.length-1}return{data:t,add:function(n){var r;return r=t.splice(++e),t.push(n),{state:n,removed:r}},undo:function(){if(n())return t[--e]},redo:function(){if(r())return t[++e]},canUndo:n,canRedo:r}}(),z=function(e){return t.rtl?e.reverse():e};function O(t){var e,n,r,o;e=i.find("#w")[0],n=i.find("#h")[0],r=parseInt(e.value(),10),o=parseInt(n.value(),10),i.find("#constrain")[0].checked()&&U&&M&&r&&o&&("w"===t.control.settings.name?(o=Math.round(r*j),n.value(o)):(r=Math.round(o*E),e.value(r))),U=r,M=o}function D(t){return Math.round(100*t)+"%"}function S(){i.find("#undo").disabled(!A.canUndo()),i.find("#redo").disabled(!A.canRedo()),i.statusbar.find("#save").disabled(!A.canUndo())}function L(){i.find("#undo").disabled(!0),i.find("#redo").disabled(!0)}function H(t){t&&d.imageSrc(t.url)}function _(t){return function(){var e=n.grep(B,function(e){return e.settings.name!==t});n.each(e,function(t){t.hide()}),t.show(),t.focus()}}function F(t){H(c=ht(t))}function P(t){H(e=ht(t)),mt(A.add(e).removed),S()}function W(){var t=d.selection();J.blobToImageResult(e.blob).then(function(e){G.crop(e,t.x,t.y,t.w,t.h).then(X).then(function(t){P(t),V()})})}var q=function(t){var n=[].slice.call(arguments,1);return function(){var r=c||e;J.blobToImageResult(r.blob).then(function(e){t.apply(this,[e].concat(n)).then(X).then(F)})}};function V(){H(e),pt(c),_(a)(),S()}function N(){c?(P(c.blob),V()):function e(n,r){c?r():setTimeout(function(){n-- >0?e(n,r):t.windowManager.alert("Error: failed to apply image operation.")},10)}(100,N)}function $(t){return it.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}var X=function(t){return t.toBlob()};function Y(t,n){return $(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",function(){L(),J.blobToImageResult(e.blob).then(function(t){return n(t)}).then(X).then(function(t){var e=ht(t);H(e),pt(c),c=e})})}function K(n,r,o,i,a){return $(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){var n;n=t.value,J.blobToImageResult(e.blob).then(function(t){return r(t,n)}).then(X).then(function(t){var e=ht(t);H(e),pt(c),c=e})},minValue:t.rtl?a:i,maxValue:t.rtl?i:a,value:o,previewFilter:D},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",function(){this.find("slider").value(o),L()})}l=$(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:W}])).hide().on("show hide",function(t){d.toggleCropRect("show"===t.type)}).on("show",L),s=$(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:O},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:O},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(j=M/U,E=U/M)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(t){var n=parseInt(i.find("#w").value(),10),r=parseInt(i.find("#h").value(),10);t.preventDefault(),function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=[].slice.call(arguments,1);return function(){J.blobToImageResult(e.blob).then(function(e){t.apply(this,[e].concat(o)).then(X).then(P)})}}(G.resize,n,r)(),V()}).on("show",L),f=$(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:q(G.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:q(G.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:q(G.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:q(G.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",L),m=Y(0,G.invert),I=Y(0,G.sharpen),T=Y(0,G.emboss),g=K(0,G.brightness,0,-1,1),v=K(0,G.hue,180,0,360),y=K(0,G.saturate,0,-1,1),b=K(0,G.contrast,0,-1,1),w=K(0,G.grayscale,0,0,1),x=K(0,G.sepia,0,0,1),R=function(n,r){function o(){var t,n,o;t=i.find("#r")[0].value(),n=i.find("#g")[0].value(),o=i.find("#b")[0].value(),J.blobToImageResult(e.blob).then(function(e){return r(e,t,n,o)}).then(X).then(function(t){var e=ht(t);H(e),pt(c),c=e})}var a=t.rtl?2:0,u=t.rtl?0:2;return $(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:a,value:1,maxValue:u,ondragend:o,previewFilter:D},{type:"slider",label:"G",name:"g",minValue:a,value:1,maxValue:u,ondragend:o,previewFilter:D},{type:"slider",label:"B",name:"b",minValue:a,value:1,maxValue:u,ondragend:o,previewFilter:D},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",function(){i.find("#r,#g,#b").value(1),L()})}(0,G.colorize),k=K(0,G.gamma,0,-1,1),C=K(0,G.exposure,1,0,2),u=$(z([{text:"Back",onclick:V},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:_(v)},{text:"saturate",icon:"saturate",onclick:_(y)},{text:"sepia",icon:"sepia",onclick:_(x)},{text:"emboss",icon:"emboss",onclick:_(T)},{text:"exposure",icon:"exposure",onclick:_(C)},{type:"spacer",flex:1}])).hide(),a=$(z([{tooltip:"Crop",icon:"crop",onclick:_(l)},{tooltip:"Resize",icon:"resize2",onclick:_(s)},{tooltip:"Orientation",icon:"orientation",onclick:_(f)},{tooltip:"Brightness",icon:"sun",onclick:_(g)},{tooltip:"Sharpen",icon:"sharpen",onclick:_(I)},{tooltip:"Contrast",icon:"contrast",onclick:_(b)},{tooltip:"Color levels",icon:"drop",onclick:_(R)},{tooltip:"Gamma",icon:"gamma",onclick:_(k)},{tooltip:"Invert",icon:"invert",onclick:_(m)}])),d=dt.create({flex:1,imageSrc:e.url}),h=it.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){H(e=A.undo()),S()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){H(e=A.redo()),S()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=d.zoom();t<2&&(t+=.1),d.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=d.zoom();t>.1&&(t-=.1),d.zoom(t)}}]}),p=it.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:z([h,d])}),B=[a,l,s,f,u,m,g,v,y,b,w,x,R,I,T,k,C],(i=t.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(ot.DOM.getViewPort().w,800),minHeight:Math.min(ot.DOM.getViewPort().h,650),title:"Edit image",items:B.concat([p]),buttons:z([{text:"Save",name:"save",subtype:"primary",onclick:function(){r(e.blob),i.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){o(),mt(A.data),A=null,c=null}),A.add(e),S(),d.on("load",function(){U=d.imageSize().w,M=d.imageSize().h,j=M/U,E=U/M,i.find("#w").value(U),i.find("#h").value(M)}),d.on("crop",W)}var vt={edit:function(t,e){return new tt(function(n,r){return e.toBlob().then(function(e){gt(t,ht(e),n,r)})})}},yt={getImageSize:function(t){var e,n;function r(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?r(e)&&r(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)},setImageSize:function(t,e){var n,r;e&&(n=t.style.width,r=t.style.height,(n||r)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,r=t.height,(n||r)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))},getNaturalImageSize:function(t){return{w:t.naturalWidth,h:t.naturalHeight}}},bt=(Array.prototype.indexOf,Array.prototype.push,Array.prototype.slice,function(t,e){for(var n=0,r=t.length;n<r;n++){var o=t[n];if(e(o,n,t))return g.some(o)}return g.none()}),wt=function(t){return null!==t&&void 0!==t},xt={traverse:function(t,e){var n;return n=e.reduce(function(t,e){return wt(t)?t[e]:void 0},t),wt(n)?n:null},readBlob:function(t){return new tt(function(e){var n=new x;n.onload=function(t){var n=t.target;e(n.result)},n.readAsText(t)})},requestUrlAsBlob:function(t,e){return new tt(function(r){var o;(o=new function(){return new(w.getOrDie("XMLHttpRequest"))}).onreadystatechange=function(){4===o.readyState&&r({status:o.status,blob:this.response})},o.open("GET",t,!0),n.each(e,function(t,e){o.setRequestHeader(e,t)}),o.responseType="blob",o.send()})},parseJson:function(t){var e;try{e=JSON.parse(t)}catch(t){}return e}},Rt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],It=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Tt=function(t){return"ImageProxy HTTP error: "+bt(Rt,function(e){return t===e.code}).fold(s.constant("Unknown ImageProxy error"),function(t){return t.message})},kt=function(t){var e=Tt(t);return tt.reject(e)},Ct=function(t){return bt(It,function(e){return e.type===t}).fold(s.constant("Unknown service error"),function(t){return t.message})},Bt=function(t,e){return xt.readBlob(e).then(function(t){var e=function(t){var e=xt.parseJson(t),n=xt.traverse(e,["error","type"]);return"ImageProxy Service error: "+(n?Ct(n):"Invalid JSON in service error message")}(t);return tt.reject(e)})},Ut={handleServiceErrorResponse:function(t,e){return 400===(n=t)||403===n||500===n?Bt(0,e):kt(t);var n},handleHttpError:kt,getHttpErrorMsg:Tt,getServiceErrorMsg:Ct},Mt=function(t,e){return xt.requestUrlAsBlob(function(t,e){var n=-1===t.indexOf("?")?"?":"&";return/[?&]apiKey=/.test(t)||!e?t:t+n+"apiKey="+encodeURIComponent(e)}(t,e),{"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e}).then(function(t){return t.status<200||t.status>=300?Ut.handleServiceErrorResponse(t.status,t.blob):tt.resolve(t.blob)})},jt=function(t,e){return e?Mt(t,e):function(t){return xt.requestUrlAsBlob(t,{}).then(function(t){return t.status<200||t.status>=300?Ut.handleHttpError(t.status):tt.resolve(t.blob)})}(t)},Et=0,At=function(t,e){t.notificationManager.open({text:e,type:"error"})},zt=function(t){return t.selection.getNode()},Ot=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new et(n).host===t.documentBaseURI.host},Dt=function(t,e){return-1!==n.inArray(t.settings.imagetools_cors_hosts,new et(e.src).host)},St=function(t){var e;return(e=t.editorUpload.blobCache.getByUri(zt(t).src))?tt.resolve(e.blob()):function(t,e){var n,r=e.src;return Dt(t,e)?jt(e.src,null):Ot(t,e)?j(e):(r=rt(t),r+=(-1===r.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),n=function(t){return t.settings.api_key||t.settings.imagetools_api_key}(t),jt(r,n))}(t,zt(t))},Lt=function(t,e){var n=Q.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()},t.settings.images_upload_timeout||3e4);e.set(n)},Ht=function(t){clearTimeout(t.get())},_t=function(t,e,n,r,o){return e.toBlob().then(function(i){var a,u,c,l,s;return c=t.editorUpload.blobCache,a=(s=zt(t)).src,t.settings.images_reuse_filename&&((l=c.getByUri(a))?(a=l.uri(),u=l.name()):u=function(t,e){var n=e.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return n?t.dom.encode(n[1]):null}(t,a)),l=c.create({id:"imagetools"+Et++,blob:i,base64:e.toBase64(),uri:a,name:u}),c.add(l),t.undoManager.transact(function(){t.$(s).on("load",function e(){t.$(s).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(Ht(r),Lt(t,r))}),o&&t.$(s).attr({width:o.w,height:o.h}),t.$(s).attr({src:l.blobUri()}).removeAttr("data-mce-src")}),l})},Ft=function(t,e,n,r){return function(){return t._scanForImages().then(s.curry(St,t)).then(J.blobToImageResult).then(n).then(function(n){return _t(t,n,!1,e,r)},function(e){At(t,e)})}},Pt={rotate:function(t,e,n){return function(){var r=yt.getImageSize(zt(t)),o=r?{w:r.h,h:r.w}:null;return Ft(t,e,function(t){return G.rotate(t,n)},o)()}},flip:function(t,e,n){return function(){return Ft(t,e,function(t){return G.flip(t,n)})()}},editImageDialog:function(t,e){return function(){var n=zt(t),r=yt.getNaturalImageSize(n),o=function(t){return new tt(function(e){M(t).then(function(o){var i=yt.getNaturalImageSize(o);r.w===i.w&&r.h===i.h||yt.getImageSize(n)&&yt.setImageSize(n,i),Z.revokeObjectURL(o.src),e(t)})})};St(t).then(J.blobToImageResult).then(s.curry(function(t,n){return vt.edit(t,n).then(o).then(J.blobToImageResult).then(function(n){return _t(t,n,!0,e)},function(){})},t),function(e){At(t,e)})}},isEditableImage:function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(Ot(t,e)||Dt(t,e)||t.settings.imagetools_proxy)},cancelTimedUpload:Ht},Wt=function(t,e){n.each({mceImageRotateLeft:Pt.rotate(t,e,-90),mceImageRotateRight:Pt.rotate(t,e,90),mceImageFlipVertical:Pt.flip(t,e,"v"),mceImageFlipHorizontal:Pt.flip(t,e,"h"),mceEditImage:Pt.editImageDialog(t,e)},function(e,n){t.addCommand(n,e)})},qt=function(t,e,n){t.on("NodeChange",function(r){var o=n.get();o&&o.src!==r.element.src&&(Pt.cancelTimedUpload(e),t.editorUpload.uploadImagesAuto(),n.set(null)),Pt.isEditableImage(t,r.element)&&n.set(r.element)})},Vt=function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})},Nt=function(t){t.addContextToolbar(s.curry(Pt.isEditableImage,t),nt(t))};e.add("imagetools",function(e){var n=t(0),r=t(null);Wt(e,n),Vt(e),Nt(e),qt(e,n,r)})}();